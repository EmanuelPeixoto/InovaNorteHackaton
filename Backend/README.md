# Golang Microservice Template – Greeting Service

This repository is a **production-ready Golang microservice template**, designed to be used either as part of a larger **microservice architecture** or as a **standalone application**.

It comes pre-configured with best practices, a clean folder structure, integration with **PostgreSQL**, code generation via **sqlc**, migrations via **goose**, API docs via **swag**, and integration tests powered by **httpexpect**.

The example service implemented here is a **Greeting Service**: it allows creating users and greeting them via different endpoints.

---

## 🚀 Features

* **Postgres integration** with `sqlc` (type-safe DB access) and `goose` (migrations)
* **Swagger docs** generated with `swag`
* **Prometheus metrics** middleware out of the box
* **Structured logging** using zap formatted with requestID and userID (when available) for easy querying in Loki
* **Standardized responses** with [MintzyG/GoResponse](https://github.com/MintzyG/GoResponse)
* **Service containerization** with Docker & Docker Compose
* **Integration testing** with `httptest` and `httpexpect`
* **Config management** with `viper`
* **DTOs & models** separated for clean layering
* **Direnv** support (`.envrc`) for local dev convenience
* **CORS middleware** ready to go

---

## 📂 Project Structure

```
.
├── main.go              # Starts the server
├── init.go              # Configures app libs and DB connection
├── sqlc.yaml            # SQLC config
├── Dockerfile            # Builds the service
├── docker-compose.yml   # Local dev (app + Postgres)
├── docker-compose.test.yml # Test DB + run tests
├── .env                 # Local environment variables (ignored)
├── .env.example         # Template for .env
├── .envrc               # Direnv loader
├── /internal
│   ├── db/              # database.go + queries/
│   ├── handler/         # handler factory + feature handlers (e.g. users.go)
│   ├── metrics/         # Prometheus integration
│   ├── logs/            # Structured logging for Loki consumption or dev work
│   ├── models/          # Models, DTOs, Request and Response objects
│   ├── repository/      # Generated by sqlc
│   ├── router/          # Sets up mux + middleware
│   ├── service/         # Business logic
│   └── validation/      # (to be removed, currently validation logic)
├── /migrations          # Goose migrations (schema for sqlc)
├── /tests               # Integration tests
└── /docs                # Auto-generated Swagger docs
```

---

## 🛠️ Dependencies

The template already integrates with:

* [sqlc](https://sqlc.dev) ✅
* [goose](https://github.com/pressly/goose) ✅
* [viper](https://github.com/spf13/viper) ✅
* [validator](https://github.com/go-playground/validator)
* [copier](https://github.com/jinzhu/copier) ✅
* [MintzyG/GoResponse](https://github.com/MintzyG/GoResponse) ✅
* [uuid](https://github.com/google/uuid) ✅
* [rs/cors](https://github.com/rs/cors) ✅
* [swag](https://github.com/swaggo/swag) ✅
* [zap](https://github.com/uber-go/zap) ✅

Planned:

* JWT inspection middleware and helpers
* Rate limiting

---

## 🐳 Running with Docker

### Local development

```bash
docker compose up --build
```

This spins up:

* `greet-dev` (the service container)
* `postgres-dev` (the Postgres DB)

The service will be available at:

* API: `http://localhost:8080`
* Swagger UI: `http://localhost:8080/swagger/index.html`
* Metrics: `http://localhost:8080/metrics`

---

### Testing

```bash
docker compose -f docker-compose.test.yml up --build --abort-on-container-exit
```

This starts:

* `postgres-test` (dedicated test DB)
* `greet-test` (runs the Go integration tests)

---

## 🧪 Testing Strategy

* Uses [`httptest`](https://pkg.go.dev/net/http/httptest) and [`httpexpect`](https://github.com/gavv/httpexpect) for integration tests.
* Tests run against a **real Postgres test DB** (spun up via `docker-compose.test.yml`).
* API responses are validated to follow the [GoResponse](https://github.com/MintzyG/GoResponse) standard.

---

## ⚙️ Development Setup (recommended)

For best DX outside Docker, install:

* [Go](https://go.dev/) (latest stable)
* [Postgres](https://www.postgresql.org/)
* [sqlc](https://sqlc.dev)
* [goose](https://github.com/pressly/goose)
* [swag](https://github.com/swaggo/swag)
* [direnv](https://direnv.net/)

Then:

```bash
cp .env.example .env
direnv allow
```

---

## 📖 API Overview

Routes exposed by the Greeting Service:

| Method | Path                        | Description                                                              |
| ------ | --------------------------- | ------------------------------------------------------------------------ |
| `POST` | `/users`                    | Create a new user                                                        |
| `GET`  | `/users`                    | Get all users                                                            |
| `GET`  | `/users/{id}`               | Get a user by ID                                                         |
| `POST` | `/greet`                    | Greet all users                                                          |
| `POST` | `/greet/{id}`               | Greet a user by ID                                                       |
| `POST` | `/greet/{id}/{greeting_id}` | (Optional) Special greet if `SPECIAL_GREETING_SERVICE_URL` is configured |
| `GET`  | `/metrics`                  | Prometheus metrics                                                       |

---

## 🔮 Roadmap

* [x] Logging middleware (structured logs + Loki integration)
* [ ] JWT validation & middleware
* [ ] Rate limiting middleware

---

## 📜 License

---
